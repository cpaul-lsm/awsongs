<script lang="ts">
	import { goto } from '$app/navigation';
	import { onMount } from 'svelte';
	import { page } from '$app/stores';
	import { songs } from '$lib/database/songlist.js';
	import { requests } from '$lib/database/requests.ts';
	
	onMount(() => {
		const params = new URLSearchParams($page.url.search);
		firstname = params.get('firstname') || '';
		comments = params.get('comments') || '';
		songPick = params.get('songPick') || '';
		console.log('Received data:', { firstname, comments, songPick });
	});
	
	let firstname = $state('');
	let comments = $state('');
	let songPick = $state('');
	
	const submitForm2 = async (e: Event) => {
		e.preventDefault();

		const formData = {
			firstname,
			comments,
			songPick
		};

		try {
			// Process the form data locally
			console.log('Form submitted with:', formData);

			// Simulate a successful form submission
			const response = { ok: true };

			if (response.ok) {
				console.log('Form submitted successfully');
				// Redirect to /request/r3 with query parameters
				const queryParams = new URLSearchParams(formData).toString();
				goto(`/request/r3?${queryParams}`);
			} else {
				console.error('Form submission failed');
				// Handle form submission failure (e.g., show an error message)
			}
		} catch (error) {
			console.error('Error submitting form:', error);
			// Handle network or other errors
		}
	};
</script>

<section class="request flex max-w-5xl flex-col items-center justify-center py-6">
	<form onsubmit={submitForm2} class="w-2/3 rounded-xl border border-gray-300 p-6">
		<div class="text-center">
			<a href="/" class="contents">
				<img src="/images/aw-logo-burg.png" alt="" class="mb-6" />
			</a>
			<h4>Welcome {firstname}!</h4>
			
			<p>Comments: {comments}</p>
			<p class="md:text-lg">Pick a song from our list below.</p>
			
		</div>
        {#each songs as song }
		{#if song.requested === 'no' && song.category === 'general'}
            <div class="form-control">
            <label class="label cursor-pointer">
				<input type="radio" name="songchecled" id="{song.title}" class="radio" value="{song.title} ({song.artist})" bind:group={songPick} />
				<span class="label-text">{song.title} ({song.artist})</span>
				
            </label>
        </div>
		{/if}
        {/each}
		<div class="songpick my-12 font-bold">
			<p>You have picked {songPick}</p>
		</div>
		<div class="flex justify-center">
			<button
				type="submit"
				class="btn flex justify-center bg-gray-700 text-white hover:bg-gray-800"
			>
				Send your request</button
			>
		</div>
	</form>
</section>
